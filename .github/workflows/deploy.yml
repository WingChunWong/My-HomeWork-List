# .github/workflows/deploy-to-pages.yml
name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发
  repository_dispatch:  # 允许通过API触发

# 设置 GITHUB_TOKEN 的权限
permissions:
  contents: read
  pages: write
  id-token: write

# 允许一个并发部署
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取所有历史，用于更好的 git 信息
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build and test website
      run: |
        echo "正在构建和测试网站..."
        
        # 检查必要文件是否存在
        echo "检查必要文件..."
        if [ ! -f "index.html" ]; then
          echo "❌ index.html 不存在"
          echo "创建基本的 index.html 文件..."
          cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在線家課表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>在線家課表</h1>
        <p>网站正在构建中，请稍后刷新页面...</p>
        <div class="spinner-border" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>
</body>
</html>
EOF
        fi
        
        if [ ! -f "script.js" ]; then
          echo "❌ script.js 不存在，创建空文件"
          echo "// 脚本文件" > script.js
        fi
        
        if [ ! -f "style.css" ]; then
          echo "❌ style.css 不存在，创建空文件"
          echo "/* 样式文件 */" > style.css
        fi
        
        # 检查 homework_data.json 是否存在，如果不存在则创建一个空的
        if [ ! -f "homework_data.json" ]; then
          echo "⚠️ homework_data.json 不存在，创建空文件"
          echo "[]" > homework_data.json
        fi
        
        # 检查 last_update.json 是否存在，如果不存在则创建一个
        if [ ! -f "last_update.json" ]; then
          echo "⚠️ last_update.json 不存在，创建默认文件"
          cat > last_update.json << EOF
{
  "last_updated": "$(date -Iseconds)",
  "workflow_run_id": "manual-build",
  "workflow_run_number": "1",
  "triggered_by": "manual",
  "timestamp": "$(date +%s)"
}
EOF
        fi
        
        # 验证 JSON 格式，如果失败则创建有效的 JSON
        echo "验证 JSON 文件格式..."
        if ! python -c "import json; json.load(open('homework_data.json'))" 2>/dev/null; then
          echo "❌ homework_data.json 格式错误，修复为有效 JSON"
          echo "[]" > homework_data.json
        fi
        
        if ! python -c "import json; json.load(open('last_update.json'))" 2>/dev/null; then
          echo "❌ last_update.json 格式错误，修复为有效 JSON"
          cat > last_update.json << EOF
{
  "last_updated": "$(date -Iseconds)",
  "workflow_run_id": "manual-build",
  "workflow_run_number": "1",
  "triggered_by": "manual",
  "timestamp": "$(date +%s)"
}
EOF
        fi
        
        # 验证文件是否现在有效
        echo "最终验证..."
        if [ -f "index.html" ] && [ -f "script.js" ] && [ -f "style.css" ] && [ -f "homework_data.json" ] && [ -f "last_update.json" ]; then
          echo "✅ 所有必要文件都存在"
        else
          echo "❌ 仍有文件缺失"
          ls -la
          exit 1
        fi
        
        # 创建部署信息文件
        cat > deploy-info.json << EOF
{
  "build_time": "$(date -Iseconds)",
  "commit_hash": "${{ github.sha }}",
  "data_records": $(python -c "import json; data = json.load(open('homework_data.json')); print(len(data))"),
  "deploy_type": "${{ github.event_name }}"
}
EOF
        
        echo "✅ 网站构建和测试完成"
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        name: github-pages

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
