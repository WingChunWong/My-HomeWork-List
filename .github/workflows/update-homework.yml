# .github/workflows/update-homework.yml
name: Update Homework Data

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 09:00 è¿è¡Œ (é¦™æ¸¯æ—¶é—´ UTC+8 15:00)
    - cron: '0 9 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_full_update:
        description: 'å¼ºåˆ¶å®Œæ•´æ›´æ–°ï¼ˆä»Ž9æœˆ1æ—¥å¼€å§‹é‡æ–°èŽ·å–ï¼‰'
        required: false
        default: false
        type: boolean

jobs:
  update-homework:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas openpyxl colorama
        
    - name: Create config file
      run: |
        cat > portal_config.json << EOF
        {
          "username": "${{ secrets.PORTAL_USERNAME }}",
          "password": "${{ secrets.PORTAL_PASSWORD }}",
          "last_updated": "${{ github.workflow }}"
        }
        EOF
        
    - name: Run homework crawler
      id: crawler
      run: |
        echo "å¼€å§‹è¿è¡Œå®¶è¯¾æ•°æ®çˆ¬è™«..."
        python homework_crawler.py
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸç”Ÿæˆæ•°æ®æ–‡ä»¶
        if [ -f "homework_data.json" ]; then
          echo "æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          echo "::set-output name=data_updated::true"
          
          # ç»Ÿè®¡è®°å½•æ•°é‡
          RECORD_COUNT=$(python -c "import json; data = json.load(open('homework_data.json')); print(len(data))")
          echo "è®°å½•æ•°é‡: $RECORD_COUNT"
          echo "::set-output name=record_count::$RECORD_COUNT"
        else
          echo "æ•°æ®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          echo "::set-output name=data_updated::false"
        fi
        
    - name: Commit and push if changes
      if: steps.crawler.outputs.data_updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
        if git diff --quiet; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæäº¤æ›´æ–°"
          git add homework_data.json homework_data.xlsx
          git commit -m "ðŸ“š è‡ªåŠ¨æ›´æ–°å®¶è¯¾æ•°æ® (${{ steps.crawler.outputs.record_count }} æ¡è®°å½•) [skip ci]"
          git push
        fi
        
    - name: Create summary
      if: always()
      run: |
        echo "# å®¶è¯¾æ•°æ®æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.crawler.outputs.data_updated }}" = "true" ]; then
          echo "âœ… **çŠ¶æ€:** æ•°æ®æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **è®°å½•æ•°é‡:** ${{ steps.crawler.outputs.record_count }} æ¡" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸ‘¤ **æ‰‹åŠ¨è§¦å‘ç”¨æˆ·:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **çŠ¶æ€:** æ•°æ®æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ è¯·æ£€æŸ¥å‡­æ®é…ç½®å’Œç½‘ç»œè¿žæŽ¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "ä¸‹æ¬¡è‡ªåŠ¨è¿è¡Œ: æ¯å¤© UTC 18:00 (é¦™æ¸¯æ—¶é—´ 02:00)" >> $GITHUB_STEP_SUMMARY
        
    - name: Upload homework data as artifact
      if: steps.crawler.outputs.data_updated == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: homework-data
        path: |
          homework_data.json
          homework_data.xlsx
        retention-days: 7
