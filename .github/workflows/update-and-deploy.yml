# .github/workflows/update-and-deploy.yml
name: Update Data and Deploy

on:
  schedule:
    - cron: '0 9 * * *'  # æ¯å¤© UTC 09:00 (é¦™æ¸¯æ—¶é—´ 17:00)
  workflow_dispatch:
    inputs:
      force_full_update:
        description: 'å¼ºåˆ¶å®Œæ•´æ›´æ–°'
        required: false
        default: false
        type: boolean

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Create config file
      run: |
        cat > portal_config.json << EOF
        {
          "username": "${{ secrets.PORTAL_USERNAME }}",
          "password": "${{ secrets.PORTAL_PASSWORD }}",
          "last_updated": "${{ github.workflow }}"
        }
        EOF
        
    - name: Run homework crawler
      id: crawler
      run: |
        echo "å¼€å§‹è¿è¡Œå®¶è¯¾æ•°æ®çˆ¬è™«..."
        python homework_crawler.py
        
        if [ -f "homework_data.json" ]; then
          echo "æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          echo "::set-output name=data_updated::true"
          
          RECORD_COUNT=$(python -c "import json; data = json.load(open('homework_data.json')); print(len(data))")
          echo "è®°å½•æ•°é‡: $RECORD_COUNT"
          echo "::set-output name=record_count::$RECORD_COUNT"
        else
          echo "æ•°æ®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          echo "::set-output name=data_updated::false"
        fi
        
    - name: Commit and push if changes
      if: steps.crawler.outputs.data_updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet homework_data.json homework_data.xlsx; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ•°æ®æ–‡ä»¶å˜æ›´"
          echo "::set-output name=has_changes::false"
        else
          echo "æ£€æµ‹åˆ°æ•°æ®æ–‡ä»¶å˜æ›´ï¼Œæäº¤æ›´æ–°"
          git add homework_data.json homework_data.xlsx
          git commit -m "ðŸ“š è‡ªåŠ¨æ›´æ–°å®¶è¯¾æ•°æ® (${{ steps.crawler.outputs.record_count }} æ¡è®°å½•)"
          git push
          echo "::set-output name=has_changes::true"
        fi
        
    - name: Create summary
      if: always()
      run: |
        echo "# å®¶è¯¾æ•°æ®æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.crawler.outputs.data_updated }}" = "true" ]; then
          echo "âœ… **çŠ¶æ€:** æ•°æ®æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **è®°å½•æ•°é‡:** ${{ steps.crawler.outputs.record_count }} æ¡" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸ‘¤ **æ‰‹åŠ¨è§¦å‘ç”¨æˆ·:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.crawler.outputs.has_changes }}" = "true" ]; then
            echo "ðŸš€ **éƒ¨ç½²çŠ¶æ€:** å·²è§¦å‘è‡ªåŠ¨éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **éƒ¨ç½²çŠ¶æ€:** æ— æ•°æ®å˜æ›´ï¼Œæ— éœ€éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **çŠ¶æ€:** æ•°æ®æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ è¯·æ£€æŸ¥å‡­æ®é…ç½®å’Œç½‘ç»œè¿žæŽ¥" >> $GITHUB_STEP_SUMMARY
        fi
        
    outputs:
      has_changes: ${{ steps.crawler.outputs.has_changes }}
      record_count: ${{ steps.crawler.outputs.record_count }}

  deploy:
    name: Deploy to GitHub Pages
    needs: update-data
    if: needs.update-data.outputs.has_changes == 'true'
    
    permissions:
      contents: read
      pages: write
      id-token: write

    concurrency:
      group: "pages"
      cancel-in-progress: false

    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build and test website
      run: |
        echo "æ­£åœ¨æž„å»ºç½‘ç«™..."
        
        # éªŒè¯å¿…è¦æ–‡ä»¶
        [ -f "index.html" ] || exit 1
        [ -f "script.js" ] || exit 1
        [ -f "style.css" ] || exit 1
        [ -f "homework_data.json" ] || exit 1
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
        cat > version.json << EOF
        {
          "build_time": "$(date -Iseconds)",
          "commit_hash": "${{ github.sha }}",
          "data_records": ${{ needs.update-data.outputs.record_count }},
          "deploy_type": "auto-update"
        }
        EOF
        
        echo "âœ… ç½‘ç«™æž„å»ºå®Œæˆ"
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: .
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
