# .github/workflows/update-data.yml
name: Update Homework Data

on:
  schedule:
    - cron: '0 9 * * *'  # æ¯å¤© UTC 09:00 (é¦™æ¸¯æ—¶é—´ 17:00)
  workflow_dispatch:
    inputs:
      force_full_update:
        description: 'å¼ºåˆ¶å®Œæ•´æ›´æ–°'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f "requirements.txt" ]; then
          pip install -r requirements.txt
        else
          pip install requests beautifulsoup4 pandas openpyxl colorama
        fi
        
    - name: Run homework crawler
      id: crawler
      run: |
        echo "å¼€å§‹è¿è¡Œå®¶è¯¾æ•°æ®çˆ¬è™«..."
        
        # æ£€æŸ¥çˆ¬è™«è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "homework_crawler.py" ]; then
          echo "âŒ homework_crawler.py ä¸å­˜åœ¨"
          echo "data_updated=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        # è¿è¡Œçˆ¬è™«
        python homework_crawler.py
        
        # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†æ•°æ®æ–‡ä»¶
        if [ -f "homework_data.json" ]; then
          echo "æ•°æ®æ–‡ä»¶ç”ŸæˆæˆåŠŸ"
          
          # éªŒè¯JSONæ ¼å¼
          if python -c "import json; json.load(open('homework_data.json'))" 2>/dev/null; then
            RECORD_COUNT=$(python -c "import json; data = json.load(open('homework_data.json')); print(len(data))")
            echo "è®°å½•æ•°é‡: $RECORD_COUNT"
            echo "data_updated=true" >> $GITHUB_OUTPUT
            echo "record_count=$RECORD_COUNT" >> $GITHUB_OUTPUT
          else
            echo "âŒ homework_data.json æ ¼å¼é”™è¯¯"
            echo "data_updated=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ æ•°æ®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
          echo "data_updated=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create last update info file
      if: steps.crawler.outputs.data_updated == 'true'
      run: |
        cat > last_update.json << EOF
        {
          "last_updated": "$(date -Iseconds)",
          "workflow_run_id": "${{ github.run_id }}",
          "workflow_run_number": "${{ github.run_number }}",
          "triggered_by": "${{ github.event_name }}",
          "timestamp": "$(date +%s)"
        }
        EOF
        echo "âœ… æœ€åŽæ›´æ–°æ—¶é—´æ–‡ä»¶åˆ›å»ºæˆåŠŸ"
        
    - name: Configure Git
      if: steps.crawler.outputs.data_updated == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: Check for changes
      id: git-check
      if: steps.crawler.outputs.data_updated == 'true'
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        git add homework_data.json homework_data.xlsx last_update.json portal_config.json
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        fi
        
    - name: Commit and push changes
      if: steps.git-check.outputs.has_changes == 'true'
      run: |
        echo "æäº¤å¹¶æŽ¨é€å˜æ›´..."
        CURRENT_DATE=$(date +"%Y-%m-%d")
        COMMIT_MESSAGE="ðŸ“š è‡ªåŠ¨æ›´æ–°å®¶è¯¾æ•°æ® (${{ steps.crawler.outputs.record_count }} æ¡è®°å½•) - $CURRENT_DATE"
        git commit -m "$COMMIT_MESSAGE"
        git push
        
    - name: Trigger deployment
      if: steps.git-check.outputs.has_changes == 'true'
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            console.log('âœ… å·²æˆåŠŸè§¦å‘éƒ¨ç½²å·¥ä½œæµ');
          } catch (error) {
            console.log('âš ï¸ è§¦å‘éƒ¨ç½²å·¥ä½œæµå¤±è´¥ï¼Œä½†æ•°æ®å·²æ›´æ–°');
            console.log('é”™è¯¯ä¿¡æ¯:', error.message);
          }
        
    - name: Create summary
      if: always()
      run: |
        echo "# å®¶è¯¾æ•°æ®æ›´æ–°æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è¿è¡Œæ—¶é—´:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.crawler.outputs.data_updated }}" = "true" ]; then
          echo "âœ… **çŠ¶æ€:** æ•°æ®æ›´æ–°æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š **è®°å½•æ•°é‡:** ${{ steps.crawler.outputs.record_count }} æ¡" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”„ **è§¦å‘æ–¹å¼:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸ‘¤ **æ‰‹åŠ¨è§¦å‘ç”¨æˆ·:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.git-check.outputs.has_changes }}" = "true" ]; then
            echo "ðŸš€ **éƒ¨ç½²çŠ¶æ€:** å·²è§¦å‘è‡ªåŠ¨éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **éƒ¨ç½²çŠ¶æ€:** æ— æ•°æ®å˜æ›´ï¼Œæ— éœ€éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "âŒ **çŠ¶æ€:** æ•°æ®æ›´æ–°å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ è¯·æ£€æŸ¥å‡­æ®é…ç½®å’Œç½‘ç»œè¿žæŽ¥" >> $GITHUB_STEP_SUMMARY
        fi
